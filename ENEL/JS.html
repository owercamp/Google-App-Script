<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
  integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"
  integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.datatables.net/v/dt/dt-1.13.4/b-2.3.6/r-2.4.1/datatables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.3/sweetalert2.min.js"
  integrity="sha512-eN8dd/MGUx/RgM4HS5vCfebsBxvQB2yI0OS5rfmqfTo8NIseU+FenpNoa64REdgFftTY4tm0w8VMj5oJ8t+ncQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function () {
    $('#central').select2({
      placeholder: 'Centrales',
      selectOnClose: true
    });
  })
  window.addEventListener("load", general(""));
  window.addEventListener("load", listCentrals());
  /*** instanciación de los DataTables ***/
  let tbl_general = $("#tbl_data").DataTable({
    language: {
      "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
    },
    columnDefs: [
      {
        className: "myCustomCenter", targets: "_all"
      }
    ],
    fixedColumns: true,
    responsive: true,
    pagingType: "full_numbers"
  });

  let tbl_framingham = $("#tbl_framingham").DataTable({
    language: {
      "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
    },
    columnDefs: [
      {
        className: "myCustomCenter", targets: "_all"
      }
    ],
    fixedColumns: true,
    responsive: true,
    pagingType: "full_numbers"
  });

  let tbl_metabolic = $("#tbl_metabolic").DataTable({
    language: {
      "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
    },
    columnDefs: [
      {
        className: "myCustomCenter", targets: "_all"
      }
    ],
    fixedColumns: true,
    responsive: true,
    pagingType: "full_numbers"
  });

  let tbl_aterogenic = $("#tbl_aterogenic").DataTable({
    language: {
      "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
    },
    columnDefs: [
      {
        className: "myCustomCenter", targets: "_all"
      }
    ],
    fixedColumns: true,
    responsive: true,
    pagingType: "full_numbers"
  });

  function firstLetter(info) {
    let letter = info.split(" ");
    let wordsConverted = letter.map(letter => letter.charAt(0).toUpperCase() + letter.slice(1).toLowerCase());
    let letterConverted = wordsConverted.join(" ");

    return letterConverted;
  }

  $(document).on("change", "#central", function () {
    const selection = $(this).select2('data');
    const text = selection[0].text;
    let response = "";
    swal.fire({
      text: `¿Desea realizar la búsqueda por ${firstLetter(text)}?`,
      button: {
        text: "Buscar",
        closeModal: false,
      },
    })
      .then(willSearch => {
        if (willSearch) {
          response = general(text);
        }
        Swal.fire({
          icon: 'info',
          html: `<p>Realizando consulta de los datos para la terminal <b style="color:Red;"><i>${firstLetter(text)}</i></b></p>`,
          footer: `<p style="color:#5faefe">Por favor espere..</p>`,
          showConfirmButton: false,
        });
      })
  });

  function listCentrals() {
    let filter = [];
    google.script.run.withSuccessHandler(data => {
      let row = JSON.parse(data);
      $("#central").empty();
      $("#central").append(`<option value=""></option>`);
      $("#central").append(`<option value="TODAS">TODAS</option>`);
      row.forEach(element => {
        if (!filter.includes(element[3])) {
          filter.push(element[3]);
          $("#central").append(`<option value="${element[3]}">${element[3]}</option>`);
        }
      });
    })
      .withFailureHandler(error => {
        console.log(error);
      })
      .getCentrals();
  }

  const references = {
    HIGH: {
      High: "Alto",
      Counter: 0
    },
    MEDIUM: {
      Medium: "Moderado",
      Counter: 0
    },
    LOW: {
      Low: "Bajo",
      Counter: 0
    },
    NOLEVEL: {
      Counter: 0
    }
  }

  function testFramingham(params = "", selected = "") {
    let graphFramingham;
    let centrals = [];
    const framinghamChart = document.getElementById("myFramingham");

    if (selected) {
      graphFramingham.destroy();
      tbl_framingham.clear().draw();
    }

    params.forEach(element => {
      if (!centrals.includes(element[3])) {
        centrals.push(element[3]);
      }
    })

    let registerAdd = [];
    console.log(params);
    centrals.sort().map(central => {
      references.HIGH.Counter = 0;
      references.MEDIUM.Counter = 0;
      references.LOW.Counter = 0;
      references.NOLEVEL.Counter = 0;
      params.forEach(register => {
        if (register[3] === central && register[25].includes(references.HIGH.High)) {
          references.HIGH.Counter++;
        } else if (register[3] === central && register[25].includes(references.MEDIUM.Medium)) {
          references.MEDIUM.Counter++;
        } else if (register[3] === central && register[25].includes(references.LOW.Low)) {
          references.LOW.Counter++;
        } else if (register[3] === central && ![references.HIGH.High, references.MEDIUM.Medium, references.LOW.Low].includes(register[25])) {
          references.NOLEVEL.Counter++;
        }
      })

      registerAdd.push({
        0: central,
        1: "Alto",
        2: references.HIGH.Counter
      })
      registerAdd.push({
        0: central,
        1: "Moderado",
        2: references.MEDIUM.Counter
      })
      registerAdd.push({
        0: central,
        1: "Bajo",
        2: references.LOW.Counter
      })
      registerAdd.push({
        0: central,
        1: "Sin Dato",
        2: references.NOLEVEL.Counter
      })
    })
    tbl_framingham.rows.add(registerAdd).draw();

    tbl_framingham.on('draw.dt', function () {
      var rows = $('#tbl_framingham tbody tr');
      for (var i = 0; i < rows.length; i += 4) {
        var rowspan = 4;
        rows.eq(i).find('td:eq(0)').attr('rowspan', rowspan);

        // Ocultar las celdas en las filas cubiertas por rowspan
        if (rowspan > 1) {
          rows.slice(i + 1, i + rowspan).find('td:eq(0)').hide();
        }
      }
    });

    graphFramingham = new Chart(framinghamChart, {
      type: 'doughnut',
      data: {
        labels: centrals.sort(),
        datasets: [{
          label: "Car Speed",
          data: [0, 59, 75, 20, 20, 55, 40],
        }]
      }
    });
  }

  function testMetabolic(params = "", selected = "") {
    let graphMetabolic;
    const metabolicChart = document.getElementById("myMetabolic");

    if (selected) {
      graphMetabolic.destroy();
    }

    graphMetabolic = new Chart(metabolicChart, {
      type: 'pie',
      data: {
        labels: ["0s", "10s", "20s", "30s", "40s", "50s", "60s"],
        datasets: [{
          label: "Car Speed",
          data: [0, 59, 75, 20, 20, 55, 40],
        }]
      }
    });
  }

  function testAterogenic(params = "", selected = "") {
    let graphArterogenic;
    const arterogenicChart = document.getElementById("myArterogenic");

    if (selected) {
      graphArterogenic.destroy();
    }

    graphArterogenic = new Chart(arterogenicChart, {
      type: 'radar',
      data: {
        labels: ["0s", "10s", "20s", "30s", "40s", "50s", "60s"],
        datasets: [{
          label: "Car Speed",
          data: [0, 59, 75, 20, 20, 55, 40],
        }]
      }
    });
  }

  function general(selected) {
    let generalInfo = google.script.run.withSuccessHandler(element => {
      let row = JSON.parse(element);
      let insertRow = [];
      if (selected) {
        tbl_general.clear().draw();
      }
      row.map(register => {
        insertRow.push({
          0: register[6],
          1: firstLetter(register[5]),
          2: firstLetter(register[3]),
          3: register[25],
          4: register[26],
          5: register[27],
          6: register[28]
        })
      });

      tbl_general.rows.add(insertRow).draw();

      /*** instanciación de la gráficas ***/
      testFramingham(row, selected);
      testMetabolic(row, selected);
      testAterogenic(row, selected);


      var rows = $('#tbl_framingham tbody tr');
      for (var i = 0; i < rows.length; i += 4) {
        var rowspan = 4;
        rows.eq(i).find('td:eq(0)').attr('rowspan', rowspan);

        // Ocultar las celdas en las filas cubiertas por rowspan
        if (rowspan > 1) {
          rows.slice(i + 1, i + rowspan).find('td:eq(0)').hide();
        }
      }

      if (selected) {
        Swal.fire({
          icon: 'success',
          html: `<p>Success</p>`,
          showConfirmButton: false,
          timer: 3000
        });
      }
    })
      .withFailureHandler(error => {
        console.log(error);
      })
    if (selected) {
      generalInfo.getGeneral(selected);
    } else {
      generalInfo.getGeneral();
    }
  }
</script>