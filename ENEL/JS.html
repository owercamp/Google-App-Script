<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
  integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"
  integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.datatables.net/v/dt/dt-1.13.4/b-2.3.6/r-2.4.1/datatables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.3/sweetalert2.min.js"
  integrity="sha512-eN8dd/MGUx/RgM4HS5vCfebsBxvQB2yI0OS5rfmqfTo8NIseU+FenpNoa64REdgFftTY4tm0w8VMj5oJ8t+ncQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function () {
    let graphFramingham;
    let graphMetabolic;
    let graphArterogenic;
    $('div.sample').hide().first().show();

    $(document).on('click', 'a.display', function (e) {
      e.preventDefault();
      let that = $('div.sample:visible'),
        t = e.target.id;

      if (t == 'next' && that.next('div.sample').length > 0) {
        $('div.sample').hide().removeClass("select");
        that.next('div.sample').show().addClass("select");
      } else if (t == 'prev' && that.prev('div.sample').length > 0) {
        $('div.sample').hide().removeClass("select");
        that.hide().prev('div.sample').show().addClass("select");
      }
    });

    $('#central').select2({
      placeholder: 'Centrales',
      selectOnClose: true
    });
  })
  window.addEventListener("load", general(""));
  window.addEventListener("load", listCentrals());
  /*** instanciación de los DataTables ***/
  let tbl_general = $("#tbl_data").DataTable({
    language: {
      "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
    },
    columnDefs: [
      {
        className: "myCustomCenter", targets: "_all"
      }
    ],
    fixedColumns: true,
    responsive: true,
    pagingType: "full_numbers"
  });

  let tbl_framingham = $("#tbl_framingham").DataTable({
    language: {
      "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
    },
    columnDefs: [
      {
        className: "myCustomCenter", targets: "_all"
      }
    ],
    fixedColumns: true,
    responsive: true,
    pagingType: "full_numbers"
  });

  let tbl_metabolic = $("#tbl_metabolic").DataTable({
    language: {
      "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
    },
    columnDefs: [
      {
        className: "myCustomCenter", targets: "_all"
      }
    ],
    fixedColumns: true,
    responsive: true,
    pagingType: "full_numbers"
  });

  let tbl_aterogenic = $("#tbl_aterogenic").DataTable({
    language: {
      "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
    },
    columnDefs: [
      {
        className: "myCustomCenter", targets: "_all"
      }
    ],
    fixedColumns: true,
    responsive: true,
    pagingType: "full_numbers"
  });

  // Transforms the first letter of each word in a given string to uppercase and the rest of the letters to lowercase.

  // Parameters:
  // - info: a string that contains one or more words separated by spaces.

  // Returns:
  // - A new string where the first letter of each word is capitalized and the rest of the letters are lowercase.
  function firstLetter(info) {
    let letter = info.split(" ");
    let wordsConverted = letter.map(letter => letter.charAt(0).toUpperCase() + letter.slice(1).toLowerCase());
    let letterConverted = wordsConverted.join(" ");

    return letterConverted;
  }

  $(document).on("change", "#central", function () {
    const selection = $(this).select2('data');
    const text = selection[0].text;
    let response = "";
    swal.fire({
      text: `¿Desea realizar la búsqueda por ${firstLetter(text)}?`,
      button: {
        text: "Buscar",
        closeModal: false,
      },
    })
      .then(willSearch => {
        if (willSearch) {
          response = general(text);
        }
        Swal.fire({
          icon: 'info',
          html: `<p>Realizando consulta de los datos para la terminal <b style="color:Red;"><i>${firstLetter(text)}</i></b></p>`,
          footer: `<p style="color:#5faefe">Por favor espere..</p>`,
          showConfirmButton: false,
        });
      })
  });

  // Retrieves a list of centrals from the server and populates the 'central' dropdown menu.
  function listCentrals() {
    let filter = [];
    google.script.run.withSuccessHandler(data => {
      let row = JSON.parse(data);
      $("#central").empty();
      $("#central").append(`<option value=""></option>`);
      $("#central").append(`<option value="TODAS">TODAS</option>`);
      row.forEach(element => {
        if (!filter.includes(element[3])) {
          filter.push(element[3]);
          $("#central").append(`<option value="${element[3]}">${element[3]}</option>`);
        }
      });
    })
      .withFailureHandler(error => {
        console.log(error);
      })
      .getCentrals();
  }

  const referencesFramingham = {
    HIGH: {
      High: "Alto",
      Counter: 0
    },
    MEDIUM: {
      Medium: "Moderado",
      Counter: 0
    },
    LOW: {
      Low: "Bajo",
      Counter: 0
    },
    NOLEVEL: {
      Counter: 0
    }
  }

  const referencesMetabolic = {
    withAlterations: {
      message: "Presenta SINDROME METABOLICO",
      Counter: 0
    },
    withoutAlterations: {
      message: "Sin Alteraciones",
      Counter: 0
    },
    requiredData: {
      message: "El valor VACIO",
      Counter: 0
    }
  }

  const referencesAterogenic = {
    "HIGH": {
      "High": "Maximo",
      "Counter": 0
    },
    "MEDIUM": {
      "Medium": "Moderado",
      "Counter": 0
    },
    "LOW": {
      "Low": "Minimo",
      "Counter": 0
    },
  }

  function testFramingham(params = "", selected = "") {
    let centrals = [];
    let highValue = [];
    let mediumValue = [];
    let lowValue = [];
    let noLevelValue = [];
    const framinghamChart = document.getElementById("myFramingham");

    if (selected) {
      graphFramingham.destroy();
      tbl_framingham.clear().draw();
    }

    params.forEach(element => {
      if (!centrals.includes(element[3])) {
        centrals.push(element[3]);
      }
    })

    let registerAdd = [];
    centrals.sort().forEach(central => {
      referencesFramingham.HIGH.Counter = 0;
      referencesFramingham.MEDIUM.Counter = 0;
      referencesFramingham.LOW.Counter = 0;
      referencesFramingham.NOLEVEL.Counter = 0;
      params.forEach(register => {
        if (register[3] === central && register[25].includes(referencesFramingham.HIGH.High)) {
          referencesFramingham.HIGH.Counter++;
        } else if (register[3] === central && register[25].includes(referencesFramingham.MEDIUM.Medium)) {
          referencesFramingham.MEDIUM.Counter++;
        } else if (register[3] === central && register[25].includes(referencesFramingham.LOW.Low)) {
          referencesFramingham.LOW.Counter++;
        } else if (register[3] === central && ![referencesFramingham.HIGH.High, referencesFramingham.MEDIUM.Medium, referencesFramingham.LOW.Low].includes(register[25])) {
          referencesFramingham.NOLEVEL.Counter++;
        }
      })

      registerAdd.push({
        0: central,
        1: referencesFramingham.HIGH.High,
        2: referencesFramingham.HIGH.Counter
      })
      registerAdd.push({
        0: central,
        1: referencesFramingham.MEDIUM.Medium,
        2: referencesFramingham.MEDIUM.Counter
      })
      registerAdd.push({
        0: central,
        1: referencesFramingham.LOW.Low,
        2: referencesFramingham.LOW.Counter
      })
      registerAdd.push({
        0: central,
        1: "Sin Dato",
        2: referencesFramingham.NOLEVEL.Counter
      })
      highValue.push(referencesFramingham.HIGH.Counter)
      mediumValue.push(referencesFramingham.MEDIUM.Counter)
      lowValue.push(referencesFramingham.LOW.Counter)
      noLevelValue.push(referencesFramingham.NOLEVEL.Counter)
    })
    tbl_framingham.rows.add(registerAdd).draw();

    tbl_framingham.on('draw.dt', function () {
      var rows = $('#tbl_framingham tbody tr');
      for (var i = 0; i < rows.length; i += 4) {
        var rowspan = 4;
        rows.eq(i).find('td:eq(0)').attr('rowspan', rowspan);
        rows.eq(i).find('td:eq(1)').addClass('d-clamp');
        rows.eq(i).find('td:eq(2)').addClass('d-clamp');

        // Ocultar las celdas en las filas cubiertas por rowspan
        if (rowspan > 1) {
          rows.slice(i + 1, i + rowspan).find('td:eq(0)').hide();
        }
      }
    });

    graphFramingham = new Chart(framinghamChart, {
      type: 'line',
      data: {
        labels: centrals.sort(),
        datasets: [{
          label: referencesFramingham.HIGH.High,
          data: highValue,
          pointStyle: 'rectRounded',
          pointRadius: 6,
          borderColor: 'rgba(201, 14, 14, 0.7)',
          backgroundColor: 'rgba(201, 14, 14, 0.5)',
          fill: {
            target: 'origin',
            above: 'rgba(201, 14, 14, 0.5)',
          }
        },
        {
          label: referencesFramingham.MEDIUM.Medium,
          data: mediumValue,
          pointStyle: 'rectRounded',
          pointRadius: 6,
          borderColor: 'rgba(192, 201, 14, 0.7)',
          backgroundColor: 'rgba(192, 201, 14, 0.5)',
          fill: {
            target: 'origin',
            above: 'rgba(192, 201, 14, 0.5)',
          }
        },
        {
          label: referencesFramingham.LOW.Low,
          data: lowValue,
          pointStyle: 'rectRounded',
          pointRadius: 6,
          borderColor: 'rgba(17, 201, 14, 0.7)',
          backgroundColor: 'rgba(17, 201, 14, 0.5)',
          fill: {
            target: 'origin',
            above: 'rgba(17, 201, 14, 0.5)',
          }
        },
        {
          label: "Sin Dato",
          data: noLevelValue,
          pointStyle: 'rectRounded',
          pointRadius: 6,
          borderColor: 'rgba(59, 59, 59, 0.7)',
          backgroundColor: 'rgba(59, 59, 59, 0.5)',
          fill: {
            target: 'origin',
            above: 'rgba(59, 59, 59, 0.5)',
          }
        }
        ]
      },
      options: {
        plugins: {
          tooltip: {
            mode: 'index',
            axis: "y",
            position: "nearest",
            backgroundColor: 'rgba(5, 85, 250, 0.6)'
          }
        }
      }
    });
  }

  function testMetabolic(params = "", selected = "") {
    let centrals = [];
    let withAlterations = [];
    let withoutAlterations = [];
    let requiredData = [];
    const metabolicChart = document.getElementById("myMetabolic");

    if (selected) {
      graphMetabolic.destroy();
      tbl_metabolic.clear().draw();
    }

    params.forEach(element => {
      if (!centrals.includes(element[3])) {
        centrals.push(element[3]);
      }
    })

    let registerAdd = [];

    centrals.sort().forEach(central => {
      referencesMetabolic.withAlterations.Counter = 0;
      referencesMetabolic.withoutAlterations.Counter = 0;
      referencesMetabolic.requiredData.Counter = 0;
      params.forEach(register => {
        if (register[3] === central && register[26].includes(referencesMetabolic.withAlterations.message)) {
          referencesMetabolic.withAlterations.Counter++;
        } else if (register[3] === central && register[26].includes(referencesMetabolic.withoutAlterations.message)) {
          referencesMetabolic.withoutAlterations.Counter++;
        } else if (register[3] === central && register[26].includes(referencesMetabolic.requiredData.message)) {
          referencesMetabolic.requiredData.Counter++;
        }
      })

      let alteration = referencesMetabolic.withAlterations.Counter;
      registerAdd.push({
        0: central,
        1: referencesMetabolic.withAlterations.message,
        2: alteration
      })
      let outAlteration = referencesMetabolic.withoutAlterations.Counter;
      registerAdd.push({
        0: central,
        1: referencesMetabolic.withoutAlterations.message,
        2: outAlteration
      })
      let unknown = referencesMetabolic.requiredData.Counter;
      registerAdd.push({
        0: central,
        1: referencesMetabolic.requiredData.message,
        2: unknown
      })
      withAlterations.push(alteration);
      withoutAlterations.push(outAlteration);
      requiredData.push(unknown);
    })
    tbl_metabolic.rows.add(registerAdd).draw();

    tbl_metabolic.on('draw.dt', function () {
      var rows = $('#tbl_metabolic tbody tr');
      for (var i = 0; i < rows.length; i += 3) {
        var rowspan = 3;
        rows.eq(i).find('td:eq(0)').attr('rowspan', rowspan);
        rows.eq(i).find('td:eq(1)').addClass('d-clamp');
        rows.eq(i).find('td:eq(2)').addClass('d-clamp');

        // Ocultar las celdas en las filas cubiertas por rowspan
        if (rowspan > 1) {
          rows.slice(i + 1, i + rowspan).find('td:eq(0)').hide();
        }
      }
    });

    console.log(registerAdd);
    graphMetabolic = new Chart(metabolicChart, {
      type: 'bar',
      data: {
        labels: centrals.sort(),
        datasets: [{
          label: referencesMetabolic.withAlterations.message,
          data: withAlterations,
          backgroundColor: 'rgba(82, 35, 20, 0.5)',
          borderColor: 'rgb(82, 35, 20)',
        },
        {
          label: referencesMetabolic.withoutAlterations.message,
          data: withoutAlterations,
          backgroundColor: 'rgba(73, 19, 117, 0.5)',
          borderColor: 'rgb(73, 19, 117)',
        },
        {
          label: referencesMetabolic.requiredData.message,
          data: requiredData,
          backgroundColor: 'rgba(20, 82, 76, 0.5)',
          borderColor: 'rgb(20, 82, 76)',
        }]
      },
      options: {
        elements: {
          bar: {
            borderWidth: 2,
            borderRadius: 5,
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            axis: "y",
            position: "nearest",
            backgroundColor: 'rgba(0, 0, 0, 0.6)'
          }
        }
      }
    });
  }

  function testAterogenic(params = "", selected = "") {
    let centrals = [];
    const arterogenicChart = document.getElementById("myArterogenic");

    if (selected) {
      graphArterogenic.destroy();
      tbl_aterogenic.clear().draw();
    }

    params.forEach(element => {
      if (!centrals.includes(element[3])) {
        centrals.push(element[3]);
      }
    })

    let registerAdd = [];
    centrals.forEach(central => {
      referencesAterogenic.HIGH.Counter = 0;
      referencesAterogenic.MEDIUM.Counter = 0;
      referencesAterogenic.LOW.Counter = 0;
      params.forEach(register => {
        if (register[3] === central && register[27].includes(referencesAterogenic.HIGH.High)) {
          referencesAterogenic.HIGH.Counter++;
        } else if (register[3] === central && register[27].includes(referencesAterogenic.MEDIUM.Medium)) {
          referencesAterogenic.MEDIUM.Counter++;
        } else if (register[3] === central && register[27].includes(referencesAterogenic.LOW.Low)) {
          referencesAterogenic.LOW.Counter++;
        }
      })

      registerAdd.push({
        0: central,
        1: referencesAterogenic.HIGH.High,
        2: referencesAterogenic.HIGH.Counter
      })
      registerAdd.push({
        0: central,
        1: referencesAterogenic.MEDIUM.Medium,
        2: referencesAterogenic.MEDIUM.Counter
      })
      registerAdd.push({
        0: central,
        1: referencesAterogenic.LOW.Low,
        2: referencesAterogenic.LOW.Counter
      })
    })
    tbl_aterogenic.rows.add(registerAdd).draw();

    tbl_aterogenic.on('draw.dt', function () {
      var rows = $('#tbl_aterogenic tbody tr');
      for (var i = 0; i < rows.length; i += 3) {
        var rowspan = 3;
        rows.eq(i).find('td:eq(0)').attr('rowspan', rowspan);

        // Ocultar las celdas en las filas cubiertas por rowspan
        if (rowspan > 1) {
          rows.slice(i + 1, i + rowspan).find('td:eq(0)').hide();
        }
      }
    });

    graphArterogenic = new Chart(arterogenicChart, {
      type: 'radar',
      data: {
        labels: centrals.sort(),
        datasets: [{
          label: "Car Speed",
          data: [0, 59, 75, 20, 20, 55, 40],
        }]
      }
    });
  }

  function general(selected) {
    let generalInfo = google.script.run.withSuccessHandler(element => {
      let row = JSON.parse(element);
      let insertRow = [];
      if (selected) {
        tbl_general.clear().draw();
      }
      row.forEach(register => {
        insertRow.push({
          0: register[6],
          1: firstLetter(register[5]),
          2: firstLetter(register[3]),
          3: register[25],
          4: register[26],
          5: register[27],
          6: register[28]
        })
      });

      tbl_general.rows.add(insertRow).draw();

      /*** instanciación de la gráficas ***/
      testFramingham(row, selected);
      testMetabolic(row, selected);
      testAterogenic(row, selected);


      let rowsFramingham = $('#tbl_framingham tbody tr');
      for (let i = 0; i < rowsFramingham.length; i += 4) {
        let rowspan = 4;
        rowsFramingham.eq(i).find('td:eq(0)').attr('rowspan', rowspan);

        // Ocultar las celdas en las filas cubiertas por rowspan
        if (rowspan > 1) {
          rowsFramingham.slice(i + 1, i + rowspan).find('td:eq(0)').hide();
        }
      }
      let rowsMetabolic = $('#tbl_metabolic tbody tr');
      for (let i = 0; i < rowsMetabolic.length; i += 3) {
        let rowspan = 3;
        rowsMetabolic.eq(i).find('td:eq(0)').attr('rowspan', rowspan);

        // Ocultar las celdas en las filas cubiertas por rowspan
        if (rowspan > 1) {
          rowsMetabolic.slice(i + 1, i + rowspan).find('td:eq(0)').hide();
        }
      }
      let rowsAterogenic = $('#tbl_aterogenic tbody tr');
      for (let i = 0; i < rowsAterogenic.length; i += 3) {
        let rowspan = 3;
        rowsAterogenic.eq(i).find('td:eq(0)').attr('rowspan', rowspan);

        // Ocultar las celdas en las filas cubiertas por rowspan
        if (rowspan > 1) {
          rowsAterogenic.slice(i + 1, i + rowspan).find('td:eq(0)').hide();
        }
      }

      if (selected) {
        Swal.fire({
          icon: 'success',
          html: `<p>Success</p>`,
          showConfirmButton: false,
          timer: 3000
        });
      }
    })
      .withFailureHandler(error => {
        console.log(error);
      })
    if (selected) {
      generalInfo.getGeneral(selected);
    } else {
      generalInfo.getGeneral();
    }
  }
</script>